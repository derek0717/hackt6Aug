function getRequest(e,o){var n=createCORSRequest("GET",e);n&&(n.onload=function(){o(n)},n.send())}function postRequest(e,o,n){var a=createCORSRequest("POST",e);a&&(a.onload=function(){n(a)},a.send(JSON.stringify(o)))}function createCORSRequest(e,o){var n=new XMLHttpRequest;return"withCredentials"in n?n.open(e,o,!0):"undefined"!=typeof XDomainRequest?(n=new XDomainRequest,n.open(e,o)):n=null,n&&n.setRequestHeader("Content-Type","application/json"),n}function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError):console.log="Geolocation is not supported by this browser.",console.log("grabbing location")}function showError(e){switch(e.code){case e.PERMISSION_DENIED:alert("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:alert("Location information is unavailable.");break;case e.TIMEOUT:alert("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:alert("An unknown error occurred.")}}function showPosition(e){console.log("Latitude: "+e.coords.latitude+" Longitude: "+e.coords.longitude);var o=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),n=new google.maps.Marker({position:o,title:"you are here",icon:"images/loc.png"});n.setMap(map),map.panTo(e)}function addPinFromJSON(e){console.log(e);for(var o=new google.maps.LatLng(e.location.lat,e.location.lon),n=e.tags,a=!1,t="3",i=0,s=n.length;i<s;i++){switch(n[i]){case"food":t="1",a=!0;break;case"wildlife":t="2",a=!0;break;case"hackathons":t="4",a=!0;break;case"events":t="3",a=!0}if(a)break}switch(e.userId){case"user1":t+="1";break;case"user2":t+="2";break;case"user3":t+="3";break;default:t+="0"}var r="images/"+t+".png",l=new google.maps.Marker({position:o,map:map,icon:r}),s={userId:e.userId,title:e.title,message:e.message,lat:e.location.lat,lon:e.location.lon};l.addListener("click",function(e){showPinMessage(s)})}function showPinMessage(e){console.log("click"),map.panTo(new google.maps.LatLng(e.lat,e.lon));var o=$("#popup-wrap");$(o).find(".popup-title").text(e.title),$(o).find(".popup-message").text(e.message),$("#popup-wrap").fadeIn()}function placeMarker(e){void 0!=lastAddedPin&&(lastAddedPin.setMap(null),lastAddedPin=null);var o=new google.maps.Marker({position:e,map:map,icon:"images/icon.png"});lastAddedPin=o,map.panTo(e),console.log("this logs after the panTo finishes."),addPinFormPopUp(e.lat(),e.lng())}function initialize(){var e={center:new google.maps.LatLng(22.286918099999998,114.1494163),zoom:15,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("googleMap"),e),google.maps.event.addListener(map,"click",function(e){placeMarker(e.latLng,map)}),getLocation(),google.maps.event.addListenerOnce(map,"idle",function(){loadPins()})}function loadPins(){getPins(function(e){for(var o=0;o<e.length;o++)addPinFromJSON(e[o])})}function get(e){return new Promise(function(o,n){getRequest(e,function(e){200==e.status?o(e.responseText):n(Error(e))})})}function postPin(e){return new Promise(function(o,n){postRequest(apiPath+"/addPin",e,function(e){200==e.status?o(e.responseText):n(Error(e.statusText))})})}function getPins(e){getRequest(apiPath+"/getPins",function(o){200==o.status?e(JSON.parse(o.responseText)):reject(Error(o.statusText))})}function toggleFormView(){$("#addPinFormWrap").toggleClass("hide"),$("#formBackground").toggleClass("hide")}function addPinFormPopUp(e,o){$("#addPinFormWrap").removeClass("hide"),$("#formBackground").removeClass("hide"),formCoord.lat=e,formCoord.lon=o}var GlobalPinsJSON=[],map;$("#popup-wrap").on("click",function(){$(this).fadeOut()});var lastAddedPin;google.maps.event.addDomListener(window,"load",initialize);var apiPath="http://zuyin.tech/api";$("#formBackground").on("click",function(e){$("#addPinFormWrap").addClass("hide"),$("#formBackground").addClass("hide")});var formCoord={lat:0,lon:0};$("#newPinButton").on("click",function(e){var o=formCoord.lat,n=formCoord.lon,a=$("#newPinFormTags").val(),t=a.split(","),i={title:$("#newPinFormTitle").val(),message:$("#newPinFormMessage").val(),location:{lat:o,lon:n},tags:t,userId:$("#newPinFormID").val()};$("#addPinFormWrap").addClass("hide"),$("#formBackground").addClass("hide"),$("#newPinFormTags").val(""),$("#newPinFormTitle").val(""),$("#newPinFormMessage").val(""),$("#newPinFormID").val(""),postPin(i),GlobalPinsJSON.push(i),addPinFromJSON(i)}),$("#betaTestImg").on("click",function(){$("#betaTestFieldWrap").toggleClass("visible")});