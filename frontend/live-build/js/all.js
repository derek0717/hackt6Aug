function CustomMarker(e,o,t){this.latlng=e,this.args=t,this.setMap(o)}function getLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition(showPosition,showError):console.log="Geolocation is not supported by this browser.",console.log("grabbing location")}function showError(e){switch(e.code){case e.PERMISSION_DENIED:alert("User denied the request for Geolocation.");break;case e.POSITION_UNAVAILABLE:alert("Location information is unavailable.");break;case e.TIMEOUT:alert("The request to get user location timed out.");break;case e.UNKNOWN_ERROR:alert("An unknown error occurred.")}}function showPosition(e){console.log("Latitude: "+e.coords.latitude+" Longitude: "+e.coords.longitude);var o=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),t=new google.maps.Marker({position:o,title:"you are here",icon:"images/loc.png"});t.setMap(map),map.panTo(e)}function addPin(e,o){console.log("Add pin: Latitude: "+e+" Longitude: "+o);var t=new google.maps.LatLng(e,o);new CustomMarker(t,map,{pin_id:"123",title:"Red title",message:"this is a message",lat:e,lon:o})}function addPinFromJSON(e){var o=new google.maps.LatLng(e.location.lat,e.location.lon),t=new CustomMarker(o,map,{user_id:""+e.user_id,title:""+e.title,message:""+e.message,lat:e.location.lat,lon:e.location.lon});t.addListener("click",function(e){markerClick(this.LatLng)})}function showPinMessage(e){var o=$(e).data("title"),t=$(e).data("message"),n=$(e).data("lat"),a=$(e).data("lon");map.panTo(new google.maps.LatLng(n,a)),google.maps.event.addListenerOnce(map,"idle",function(){console.log(o+" "+t),console.log(e);var n=$("#popup-wrap");$(n).find(".popup-title").text(o),$(n).find(".popup-message").text(t),$("#popup-wrap").fadeIn()})}function placeMarker(e){void 0!=lastAddedPin&&lastAddedPin.setMap(null);var o=new google.maps.Marker({position:e,map:map,icon:"images/icon.png"});lastAddedPin=o,map.panTo(e),google.maps.event.addListenerOnce(map,"idle",function(){console.log("this logs after the panTo finishes."),addPinFormPopUp(e.lat(),e.lng())})}function markerClick(e){console.log("click")}function readJsonAndCreateAllPins(e){for(var o=0,t=e.length;o<t;o++)console.log(e[o]),addPinFromJSON(e[o])}function initialize(){var e={center:new google.maps.LatLng(22.286918099999998,114.1494163),zoom:15,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("googleMap"),e),google.maps.event.addListener(map,"click",function(e){placeMarker(e.latLng,map)}),getLocation()}function get(e){return new Promise(function(o,t){var n=new XMLHttpRequest;n.open("GET",e),n.onload=function(){200==n.status?o(n.response):t(Error(n.statusText))},n.onerror=function(){t(Error("Network Error"))},n.send()})}function push(e){return new Promise(function(o,t){var n=new XMLHttpRequest;n.open("PUSH",theMainURL+"/addPin"),200==n.status?o(n.response):t(Error(n.statusText)),n.onerror=function(){t(Error("Network Error"))},n.send(e)})}function addtoJSON(){}function toggleFormView(){$("#addPinFormWrap").toggleClass("hide"),$("#formBackground").toggleClass("hide")}function addPinFormPopUp(e,o){$("#addPinFormWrap").removeClass("hide"),$("#formBackground").removeClass("hide"),$("#newPinButton").on("click",function(t){var n=$("#newPinFormTags").val(),a=n.split(","),i={title:$("#newPinFormTitle").val(),message:$("#newPinFormMessage").val(),location:{lat:e,lon:o},tags:a,user_id:$("#newPinFormID").val()};$("#addPinFormWrap").addClass("hide"),$("#formBackground").addClass("hide"),$("#newPinFormTags").val(""),$("#newPinFormTitle").val(""),$("#newPinFormMessage").val(""),console.log(i),push(JSON.stringify(i)),GlobalPinsJSON.push(i),addPinFromJSON(i)})}var GlobalPinsJSON=[];CustomMarker.prototype=new google.maps.OverlayView,CustomMarker.prototype.draw=function(){var e=this,o=this.div;if(!o){o=this.div=document.createElement("div"),o.className="pin tag1",o.style.position="absolute","undefined"!=typeof e.args.user_id&&(o.dataset.user_id=e.args.user_id),"undefined"!=typeof e.args.title&&(o.dataset.title=e.args.title),"undefined"!=typeof e.args.message&&(o.dataset.message=e.args.message),"undefined"!=typeof e.args.lat&&(o.dataset.lat=e.args.lat),"undefined"!=typeof e.args.lon&&(o.dataset.lon=e.args.lon);var t;"undefined"!=typeof e.args.user_id&&(o.dataset.user_id=e.args.user_id,t=e.args.user_id),google.maps.event.addDomListener(o,"click",function(e){e.stopPropagation(),showPinMessage(this)}),this.div.innerHTML="<div><img src='images/"+t+".jpg' alt='' onerror='this.src='images/undefined.jpg''></img></div>";var n=this.getPanes();n.overlayImage.appendChild(o)}var a=this.getProjection().fromLatLngToDivPixel(this.latlng);a&&(o.style.left=a.x+"px",o.style.top=a.y+"px")},CustomMarker.prototype.remove=function(){this.div&&(this.div.parentNode.removeChild(this.div),this.div=null)},CustomMarker.prototype.getPosition=function(){return this.latlng};var map;$("#popup-wrap").on("click",function(){$(this).fadeOut()});var lastAddedPin;google.maps.event.addDomListener(window,"load",initialize);var testPin1={title:"title1",message:"some text here.",location:{lat:22.283636353214973,lon:114.1349458694458},tags:["A","B","C"],user_id:"user1"},theMainURL="/api";get(theMainURL+"/getPins").then(JSON.parse).then(function(e){var o=e;testThePins=e,console.log(o),readJsonAndCreateAllPins(e)}),$(document).on("keypress",function(e){switch(e.which){case 112:push(testPin1)}}),$("#formBackground").on("click",function(e){$("#addPinFormWrap").addClass("hide"),$("#formBackground").addClass("hide")}),$("#betaTestImg").on("click",function(){$("#betaTestFieldWrap").toggleClass("visible")});